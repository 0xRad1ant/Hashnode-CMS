{"pageProps":{"post":{"slug":"simple-steps-to-include-cdk-diffs-in-github-prs","url":"https://engineering.hashnode.com/simple-steps-to-include-cdk-diffs-in-github-prs","brief":"Hey, everyone! If you've been using AWS, chances are you've come across CDK and building cloud apps with it. As seamless as it is to deploy apps using CDK, it is equally important to monitor changes in infrastructure code and prevent issues.\nThis gui...","title":"Simple Steps to Include CDK Diffs in GitHub PRs","publishedAt":"2023-06-06T06:27:20.956Z","coverImage":{"url":"https://cdn.hashnode.com/res/hashnode/image/upload/v1686032625812/72664174-525d-44e6-bcc1-94ccd855561f.png"},"author":{"name":"Shad Mirza","profilePicture":"https://cdn.hashnode.com/res/hashnode/image/upload/v1663070035311/JaSbIMfve.jpg"},"id":"647ed1c80fce655a6be9ac07","content":{"markdown":"Hey, everyone! If you've been using AWS, chances are you've come across CDK and building cloud apps with it. As seamless as it is to deploy apps using CDK, it is equally important to monitor changes in infrastructure code and prevent issues.\n\nThis guide is here to make your life a bit easier by showing you how to include the CDK diff directly in your GitHub PR.\n\nLet's start by understanding the CDK first.\n\n## A Brief Overview of CDK (Cloud Development Kit)\n\nThe Cloud Development Kit (CDK) enables developers to define, build, and deploy cloud infrastructure as code using supported programming languages. A CDK app consists of one or more Stacks where each stack defines AWS resources it uses, such as Lambda function, EC2 instance or SNS. This CDK app is usually written in TypeScript, JavaScript, Python, Java, C# or Go.\n\nA stack is simply a collection of AWS resources in the form of constructs managed as a single unit. You instantiate constructs within a stack to declare them to AWS and connect them using well-defined interfaces.\n\nHere's an example of using a construct in AWS CDK to create an Amazon S3 bucket with public read access:\n\n```typescript\nimport { Stack, StackProps, Construct } from '@aws-cdk/core';\nimport { Bucket } from '@aws-cdk/aws-s3';\n\nexport class MyS3BucketStack extends Stack {\n  constructor(scope: Construct, id: string, props?: StackProps) {\n    super(scope, id, props);\n\n    const bucket = new Bucket(this, 'MyS3Bucket', {\n      publicReadAccess: true,\n    });\n  }\n}\n```\n\nSince a construct is a reusable piece of code that encapsulates AWS resource creation and configuration logic, we can say that these constructs are the building blocks of a CDK app. Please pay close attention to this point, as it will be crucial in understanding why it is important to assess the CDK differences effectively.\n\n## Importance of CDK Diffs in GitHub PRs (Pull Requests)\n\nAs we just learned, a CDK app enables seamless building and deployment of cloud infrastructure as code. Since we define the resources used in an app as constructs, they can be employed to analyze the differences in resource allocation when changes occur.\n\nThese changes can be harmful if overlooked, leading to poor resource allocation, inconsistencies, and fatal crashes.\n\nAt times, it may not be apparent that changes could result in the deletion and recreation of a resource. For instance, in the case of a database, this could have disastrous consequences. That's why monitoring whenever there is a change in infrastructure code is essential.\n\nThe integration of CDK diffs in GitHub Pull Requests (PRs) makes it much easier for developers to review and analyze changes in the infrastructure code. This helps streamline the development process and ensure efficient cloud infrastructure management.\n\nA CDK diff highlights any modifications, additions, or deletions made to the codebase in a concise format. Since this information is available directly within the pull request, it can be leveraged to understand the proposed changes better, assess their impact, and make informed decisions. This, in turn, helps to minimize the risk of errors and maintain the stability and security of the cloud infrastructure, ultimately leading to a more reliable and robust system.\n\nI hope I've managed to convince you why having the CDK diff available in each pull request is crucial.\n\nNow, let's proceed to learn how to incorporate them.\n\n## Creating GitHub Workflow to Include CDK Diff as a PR Comment\n\nSince we need to add a comment with the CDK difference, we will use GitHub workflow to run a job whenever there is a new pull request. Create a `yaml` file inside `.github/workflows` and follow the steps below:\n\n> [Feel free to click here if you want to skip the explanation.](#heading-heres-the-complete-script)\n\n### Step 1: Add a name for the job and make sure it runs on pull requests only\n\n```yaml\n// .github/workflows/cdk-diff-share.yaml\nname: Run CDK difference\n\non:\n  pull_request:\n    branches: ['main']\n```\n\n### Step 2: Define a Job and Set the Environment, Permissions and Machine it Runs On\n\n```yaml\njobs:\n  build:\n    name: Run CDK diff\n    environment: prod\n    runs-on: ubuntu-latest\n    permissions:\n      id-token: write\n      contents: write\n      pull-requests: write\n```\n\nMake sure you have `contents` and `pull-requests` access so that the job can post the comment.\n\n### Step 3: Define Steps to Checkout the Repo and Install Dependencies\n\n```yaml\nsteps:\n      - name: Checkout repo\n        uses: actions/checkout@v3\n        with:\n          ref: ${{ github.event.pull_request.head.ref }}\n          repository: ${{ github.event.pull_request.head.repo.full_name }}\n      - name: Install pnpm\n        uses: pnpm/action-setup@v2\n        with:\n          version: 7.27.1\n      - name: Setup Node and Cache\n        uses: actions/setup-node@v3\n        with:\n          node-version: 16\n          cache: pnpm\n      - name: Install dependencies\n        run: pnpm install --prefer-offline\n```\n\nWe are also setting up the cache to speed up the consecutive runs.\n\n### Step 4: Configure AWS credentials\n\nWe need to be authenticated to access the AWS console; let's set up the AWS credentials using an IAM role.\n\n```yaml\n- name: Configure AWS credentials\n  uses: aws-actions/configure-aws-credentials@v1-node16\n  with:\n      role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}\n      aws-region: <region-of-your-choice>\n```\n\nNote: Always use GitHub secrets to store any credentials.\n\n### Step 5: Run CDK sync\n\nRun the `CDK synth` command to generate a CloudFormation stack. We are using `aws-cdk` to run CDK commands.\n\n```yaml\n- name: CDK synth\n  run: pnpm cdk synth\n  env:\n     SKIP_SANDBOX: true\n```\n\n### Step 6: Run CDK diff\n\nRun the `CDK diff` command to compare the current stack with the deployed stack. Since we need this log in the next step to post a comment, we will also save this in a log file, say `output.log`.\n\nOnce we generate the log file, we can parse it and make it available as `GITHUB_OUTPUT`.\n\n```yaml\n- name: Run AWS CDK diff\n  run: pnpm cdk diff --app \"./cdk.out/assembly-ProdStage\" 2>&1 2>&1 | tee output.log\n   env:\n      SKIP_SANDBOX: true\n- name: Echo output log\n  id: output_log\n  run: |\n     echo \"data<<EOF\" >> $GITHUB_OUTPUT\n     echo \"$(cat output.log)\" >> $GITHUB_OUTPUT\n     echo \"EOF\" >> $GITHUB_OUTPUT\n```\n\nHere, `2>&1 2>&1 | tee output.log` redirects both stdout and stderr to `output.log` file and also prints them on the console\n\n### Step 7: Post the comment\n\nWe are using `mshick/add-pr-comment@v2` to post a log on the GitHub pull request. We will add a markdown wrapper around the log to make it appear visually appealing.\n\n```yaml\n- name: Post diff in comment\n  uses: mshick/add-pr-comment@v2\n  with:\n    message-id: cdk-diff\n    message: |\n      #### CDK Diff for ProdStage\n      <details>\n         <summary>Show diff</summary>\n         ` ` `bash\n         ${{ steps.output_log.outputs.data }}\n         ` ` `\n      </details>\n```\n\nThat's we are done. Here's how the log should appear:\n\n![](https://cdn.hashnode.com/res/hashnode/image/upload/v1682942481140/7026eab1-1cf9-460c-97e7-6495d65228d2.png align=\"center\")\n\n### Here's the complete script:\n\n```yaml\nname: Run CDK difference\n\non:\n  pull_request:\n    branches: ['main']\n\njobs:\n  build:\n    name: Run CDK diff\n    environment: prod\n    runs-on: ubuntu-latest\n    permissions:\n      id-token: write\n      contents: write\n      pull-requests: write\n    steps:\n      - name: Checkout repo\n        uses: actions/checkout@v3\n        with:\n          ref: ${{ github.event.pull_request.head.ref }}\n          repository: ${{ github.event.pull_request.head.repo.full_name }}\n      - name: Install pnpm\n        uses: pnpm/action-setup@v2\n        with:\n          version: 7.27.1\n      - name: Setup Node and Cache\n        uses: actions/setup-node@v3\n        with:\n          node-version: 16\n          cache: pnpm\n      - name: Install dependencies\n        run: pnpm install --prefer-offline\n      - name: Configure AWS credentials\n        uses: aws-actions/configure-aws-credentials@v1-node16\n        with:\n          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE }}\n          aws-region: <your-region-here>\n      - name: CDK synth\n        run: pnpm cdk synth\n        env:\n          SKIP_SANDBOX: true\n      - name: Run AWS CDK diff\n        run: pnpm cdk diff --app \"./cdk.out/assembly-ProdStage\" 2>&1 2>&1 | tee output.log\n        env:\n          SKIP_SANDBOX: true\n      - name: Save output\n        id: output_log\n        run: |\n          echo \"data<<EOF\" >> $GITHUB_OUTPUT\n          echo \"$(cat output.log)\" >> $GITHUB_OUTPUT\n          echo \"EOF\" >> $GITHUB_OUTPUT\n      - name: Post diff in comment\n        uses: mshick/add-pr-comment@v2\n        with:\n          message-id: cdk-diff\n          message: |\n            #### CDK Diff for ProdStage\n            <details>\n              <summary>Show diff</summary>\n              ` ` `bash\n              ${{ steps.output_log.outputs.data }}\n              ` ` `\n            </details>\n```\n\n> Please remove the space between backticks \\`.\n\n## **Conclusion**\n\nCDK diff in GitHub PRs helps us review and analyze changes in infrastructure code, minimizing the risk of errors and maintaining stability and security. CDK diffs highlight modifications, additions, or deletions in the codebase, enabling a better understanding of proposed changes and informed decision-making.\n\nWe learned how to utilize `cdk diff` it to see changes in the intended deployment and post them as a comment on our GitHub PRs.\n\nDo let us know if this article was helpful in the comments.","html":"<p>Hey, everyone! If you've been using AWS, chances are you've come across CDK and building cloud apps with it. As seamless as it is to deploy apps using CDK, it is equally important to monitor changes in infrastructure code and prevent issues.</p>\n<p>This guide is here to make your life a bit easier by showing you how to include the CDK diff directly in your GitHub PR.</p>\n<p>Let's start by understanding the CDK first.</p>\n<h2 id=\"heading-a-brief-overview-of-cdk-cloud-development-kit\">A Brief Overview of CDK (Cloud Development Kit)</h2>\n<p>The Cloud Development Kit (CDK) enables developers to define, build, and deploy cloud infrastructure as code using supported programming languages. A CDK app consists of one or more Stacks where each stack defines AWS resources it uses, such as Lambda function, EC2 instance or SNS. This CDK app is usually written in TypeScript, JavaScript, Python, Java, C# or Go.</p>\n<p>A stack is simply a collection of AWS resources in the form of constructs managed as a single unit. You instantiate constructs within a stack to declare them to AWS and connect them using well-defined interfaces.</p>\n<p>Here's an example of using a construct in AWS CDK to create an Amazon S3 bucket with public read access:</p>\n<pre><code class=\"lang-typescript\"><span class=\"hljs-keyword\">import</span> { Stack, StackProps, Construct } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@aws-cdk/core'</span>;\n<span class=\"hljs-keyword\">import</span> { Bucket } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@aws-cdk/aws-s3'</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> MyS3BucketStack <span class=\"hljs-keyword\">extends</span> Stack {\n  <span class=\"hljs-keyword\">constructor</span>(<span class=\"hljs-params\">scope: Construct, id: <span class=\"hljs-built_in\">string</span>, props?: StackProps</span>) {\n    <span class=\"hljs-built_in\">super</span>(scope, id, props);\n\n    <span class=\"hljs-keyword\">const</span> bucket = <span class=\"hljs-keyword\">new</span> Bucket(<span class=\"hljs-built_in\">this</span>, <span class=\"hljs-string\">'MyS3Bucket'</span>, {\n      publicReadAccess: <span class=\"hljs-literal\">true</span>,\n    });\n  }\n}\n</code></pre>\n<p>Since a construct is a reusable piece of code that encapsulates AWS resource creation and configuration logic, we can say that these constructs are the building blocks of a CDK app. Please pay close attention to this point, as it will be crucial in understanding why it is important to assess the CDK differences effectively.</p>\n<h2 id=\"heading-importance-of-cdk-diffs-in-github-prs-pull-requests\">Importance of CDK Diffs in GitHub PRs (Pull Requests)</h2>\n<p>As we just learned, a CDK app enables seamless building and deployment of cloud infrastructure as code. Since we define the resources used in an app as constructs, they can be employed to analyze the differences in resource allocation when changes occur.</p>\n<p>These changes can be harmful if overlooked, leading to poor resource allocation, inconsistencies, and fatal crashes.</p>\n<p>At times, it may not be apparent that changes could result in the deletion and recreation of a resource. For instance, in the case of a database, this could have disastrous consequences. That's why monitoring whenever there is a change in infrastructure code is essential.</p>\n<p>The integration of CDK diffs in GitHub Pull Requests (PRs) makes it much easier for developers to review and analyze changes in the infrastructure code. This helps streamline the development process and ensure efficient cloud infrastructure management.</p>\n<p>A CDK diff highlights any modifications, additions, or deletions made to the codebase in a concise format. Since this information is available directly within the pull request, it can be leveraged to understand the proposed changes better, assess their impact, and make informed decisions. This, in turn, helps to minimize the risk of errors and maintain the stability and security of the cloud infrastructure, ultimately leading to a more reliable and robust system.</p>\n<p>I hope I've managed to convince you why having the CDK diff available in each pull request is crucial.</p>\n<p>Now, let's proceed to learn how to incorporate them.</p>\n<h2 id=\"heading-creating-github-workflow-to-include-cdk-diff-as-a-pr-comment\">Creating GitHub Workflow to Include CDK Diff as a PR Comment</h2>\n<p>Since we need to add a comment with the CDK difference, we will use GitHub workflow to run a job whenever there is a new pull request. Create a <code>yaml</code> file inside <code>.github/workflows</code> and follow the steps below:</p>\n<blockquote>\n<p><a class=\"post-section-overview\" href=\"#heading-heres-the-complete-script\">Feel free to click here if you want to skip the explanation.</a></p>\n</blockquote>\n<h3 id=\"heading-step-1-add-a-name-for-the-job-and-make-sure-it-runs-on-pull-requests-only\">Step 1: Add a name for the job and make sure it runs on pull requests only</h3>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">.github/workflows/cdk-diff-share.yaml</span>\n<span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">difference</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">branches:</span> [<span class=\"hljs-string\">'main'</span>]\n</code></pre>\n<h3 id=\"heading-step-2-define-a-job-and-set-the-environment-permissions-and-machine-it-runs-on\">Step 2: Define a Job and Set the Environment, Permissions and Machine it Runs On</h3>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">build:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">diff</span>\n    <span class=\"hljs-attr\">environment:</span> <span class=\"hljs-string\">prod</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">id-token:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">pull-requests:</span> <span class=\"hljs-string\">write</span>\n</code></pre>\n<p>Make sure you have <code>contents</code> and <code>pull-requests</code> access so that the job can post the comment.</p>\n<h3 id=\"heading-step-3-define-steps-to-checkout-the-repo-and-install-dependencies\">Step 3: Define Steps to Checkout the Repo and Install Dependencies</h3>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span> <span class=\"hljs-string\">repo</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">ref:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.pull_request.head.ref</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">repository:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.pull_request.head.repo.full_name</span> <span class=\"hljs-string\">}}</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">pnpm</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">pnpm/action-setup@v2</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">version:</span> <span class=\"hljs-number\">7.27</span><span class=\"hljs-number\">.1</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Setup</span> <span class=\"hljs-string\">Node</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">Cache</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-number\">16</span>\n          <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-string\">pnpm</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">dependencies</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">--prefer-offline</span>\n</code></pre>\n<p>We are also setting up the cache to speed up the consecutive runs.</p>\n<h3 id=\"heading-step-4-configure-aws-credentials\">Step 4: Configure AWS credentials</h3>\n<p>We need to be authenticated to access the AWS console; let's set up the AWS credentials using an IAM role.</p>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Configure</span> <span class=\"hljs-string\">AWS</span> <span class=\"hljs-string\">credentials</span>\n  <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">aws-actions/configure-aws-credentials@v1-node16</span>\n  <span class=\"hljs-attr\">with:</span>\n      <span class=\"hljs-attr\">role-to-assume:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.AWS_DEPLOY_ROLE</span> <span class=\"hljs-string\">}}</span>\n      <span class=\"hljs-attr\">aws-region:</span> <span class=\"hljs-string\">&lt;region-of-your-choice&gt;</span>\n</code></pre>\n<p>Note: Always use GitHub secrets to store any credentials.</p>\n<h3 id=\"heading-step-5-run-cdk-sync\">Step 5: Run CDK sync</h3>\n<p>Run the <code>CDK synth</code> command to generate a CloudFormation stack. We are using <code>aws-cdk</code> to run CDK commands.</p>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">synth</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">cdk</span> <span class=\"hljs-string\">synth</span>\n  <span class=\"hljs-attr\">env:</span>\n     <span class=\"hljs-attr\">SKIP_SANDBOX:</span> <span class=\"hljs-literal\">true</span>\n</code></pre>\n<h3 id=\"heading-step-6-run-cdk-diff\">Step 6: Run CDK diff</h3>\n<p>Run the <code>CDK diff</code> command to compare the current stack with the deployed stack. Since we need this log in the next step to post a comment, we will also save this in a log file, say <code>output.log</code>.</p>\n<p>Once we generate the log file, we can parse it and make it available as <code>GITHUB_OUTPUT</code>.</p>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">AWS</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">diff</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">cdk</span> <span class=\"hljs-string\">diff</span> <span class=\"hljs-string\">--app</span> <span class=\"hljs-string\">\"./cdk.out/assembly-ProdStage\"</span> <span class=\"hljs-number\">2</span><span class=\"hljs-string\">&gt;&amp;1</span> <span class=\"hljs-number\">2</span><span class=\"hljs-string\">&gt;&amp;1</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">tee</span> <span class=\"hljs-string\">output.log</span>\n   <span class=\"hljs-attr\">env:</span>\n      <span class=\"hljs-attr\">SKIP_SANDBOX:</span> <span class=\"hljs-literal\">true</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Echo</span> <span class=\"hljs-string\">output</span> <span class=\"hljs-string\">log</span>\n  <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">output_log</span>\n  <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n     echo \"data&lt;&lt;EOF\" &gt;&gt; $GITHUB_OUTPUT\n     echo \"$(cat output.log)\" &gt;&gt; $GITHUB_OUTPUT\n     echo \"EOF\" &gt;&gt; $GITHUB_OUTPUT</span>\n</code></pre>\n<p>Here, <code>2&gt;&amp;1 2&gt;&amp;1 | tee output.log</code> redirects both stdout and stderr to <code>output.log</code> file and also prints them on the console</p>\n<h3 id=\"heading-step-7-post-the-comment\">Step 7: Post the comment</h3>\n<p>We are using <code>mshick/add-pr-comment@v2</code> to post a log on the GitHub pull request. We will add a markdown wrapper around the log to make it appear visually appealing.</p>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Post</span> <span class=\"hljs-string\">diff</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">comment</span>\n  <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">mshick/add-pr-comment@v2</span>\n  <span class=\"hljs-attr\">with:</span>\n    <span class=\"hljs-attr\">message-id:</span> <span class=\"hljs-string\">cdk-diff</span>\n    <span class=\"hljs-attr\">message:</span> <span class=\"hljs-string\">|\n      #### CDK Diff for ProdStage\n      &lt;details&gt;\n         &lt;summary&gt;Show diff&lt;/summary&gt;\n         ` ` `bash\n         ${{ steps.output_log.outputs.data }}\n         ` ` `\n      &lt;/details&gt;</span>\n</code></pre>\n<p>That's we are done. Here's how the log should appear:</p>\n<p><img src=\"https://cdn.hashnode.com/res/hashnode/image/upload/v1682942481140/7026eab1-1cf9-460c-97e7-6495d65228d2.png\" alt class=\"image--center mx-auto\" /></p>\n<h3 id=\"heading-heres-the-complete-script\">Here's the complete script:</h3>\n<pre><code class=\"lang-yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">difference</span>\n\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">pull_request:</span>\n    <span class=\"hljs-attr\">branches:</span> [<span class=\"hljs-string\">'main'</span>]\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">build:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">diff</span>\n    <span class=\"hljs-attr\">environment:</span> <span class=\"hljs-string\">prod</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span>\n    <span class=\"hljs-attr\">permissions:</span>\n      <span class=\"hljs-attr\">id-token:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">contents:</span> <span class=\"hljs-string\">write</span>\n      <span class=\"hljs-attr\">pull-requests:</span> <span class=\"hljs-string\">write</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span> <span class=\"hljs-string\">repo</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">ref:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.pull_request.head.ref</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">repository:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">github.event.pull_request.head.repo.full_name</span> <span class=\"hljs-string\">}}</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">pnpm</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">pnpm/action-setup@v2</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">version:</span> <span class=\"hljs-number\">7.27</span><span class=\"hljs-number\">.1</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Setup</span> <span class=\"hljs-string\">Node</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">Cache</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v3</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-number\">16</span>\n          <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-string\">pnpm</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">dependencies</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">install</span> <span class=\"hljs-string\">--prefer-offline</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Configure</span> <span class=\"hljs-string\">AWS</span> <span class=\"hljs-string\">credentials</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">aws-actions/configure-aws-credentials@v1-node16</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">role-to-assume:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.AWS_DEPLOY_ROLE</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">aws-region:</span> <span class=\"hljs-string\">&lt;your-region-here&gt;</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">synth</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">cdk</span> <span class=\"hljs-string\">synth</span>\n        <span class=\"hljs-attr\">env:</span>\n          <span class=\"hljs-attr\">SKIP_SANDBOX:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Run</span> <span class=\"hljs-string\">AWS</span> <span class=\"hljs-string\">CDK</span> <span class=\"hljs-string\">diff</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">pnpm</span> <span class=\"hljs-string\">cdk</span> <span class=\"hljs-string\">diff</span> <span class=\"hljs-string\">--app</span> <span class=\"hljs-string\">\"./cdk.out/assembly-ProdStage\"</span> <span class=\"hljs-number\">2</span><span class=\"hljs-string\">&gt;&amp;1</span> <span class=\"hljs-number\">2</span><span class=\"hljs-string\">&gt;&amp;1</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">tee</span> <span class=\"hljs-string\">output.log</span>\n        <span class=\"hljs-attr\">env:</span>\n          <span class=\"hljs-attr\">SKIP_SANDBOX:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Save</span> <span class=\"hljs-string\">output</span>\n        <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">output_log</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          echo \"data&lt;&lt;EOF\" &gt;&gt; $GITHUB_OUTPUT\n          echo \"$(cat output.log)\" &gt;&gt; $GITHUB_OUTPUT\n          echo \"EOF\" &gt;&gt; $GITHUB_OUTPUT\n</span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Post</span> <span class=\"hljs-string\">diff</span> <span class=\"hljs-string\">in</span> <span class=\"hljs-string\">comment</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">mshick/add-pr-comment@v2</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">message-id:</span> <span class=\"hljs-string\">cdk-diff</span>\n          <span class=\"hljs-attr\">message:</span> <span class=\"hljs-string\">|\n            #### CDK Diff for ProdStage\n            &lt;details&gt;\n              &lt;summary&gt;Show diff&lt;/summary&gt;\n              ` ` `bash\n              ${{ steps.output_log.outputs.data }}\n              ` ` `\n            &lt;/details&gt;</span>\n</code></pre>\n<blockquote>\n<p>Please remove the space between backticks `.</p>\n</blockquote>\n<h2 id=\"heading-conclusion\"><strong>Conclusion</strong></h2>\n<p>CDK diff in GitHub PRs helps us review and analyze changes in infrastructure code, minimizing the risk of errors and maintaining stability and security. CDK diffs highlight modifications, additions, or deletions in the codebase, enabling a better understanding of proposed changes and informed decision-making.</p>\n<p>We learned how to utilize <code>cdk diff</code> it to see changes in the intended deployment and post them as a comment on our GitHub PRs.</p>\n<p>Do let us know if this article was helpful in the comments.</p>\n"},"ogMetaData":{"image":"https://cdn.hashnode.com/res/hashnode/image/upload/v1686032810745/8f23f4fe-65cd-456d-a263-fa5d74d7c59f.png"}}},"__N_SSG":true}